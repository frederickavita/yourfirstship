{{extend 'malayout.html'}}

<link rel="manifest" href="{{=URL('default', 'web_manifest', vars=dict(project_uid=project.project_uid))}}">

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("{{=URL('static', 'js/sw_empty.js')}}")
            .then(reg => console.log('Service Worker PWA enregistrÃ©', reg))
            .catch(err => console.log('Erreur SW', err));
    }
</script>


<style>
    /* Un peu de style pour le studio */
    #app-root {
        border: 2px dashed #ccc;
        min-height: 80vh;
        padding: 20px;
        background-color: #f9f9f9;
        margin-top: 20px;
    }
    .loading { color: #666; font-style: italic; }
</style>

<div class="container">
    <h1>ðŸš€ Studio: {{=project.title}}</h1>
    <p>Mode Ã‰dition - <span style="color:green">ConnectÃ© via Token SÃ©curisÃ©</span></p>
    
    <div id="app-root">
        <div class="loading">Chargement du moteur graphique...</div>
    </div>
</div>

<script>
    // Ces variables sont remplies par Web2py avant d'envoyer la page
    var PROJECT_UID = "{{=project.project_uid}}";
    var STUDIO_TOKEN = "{{=studio_token}}"; 
    
    // DÃ©marrage de Brython
    window.onload = function() {
        brython();
    }
</script>


<script type="text/python"> 
from browser import document, window, alert, ajax
import json

# 1. RÃ‰CUPÃ‰RATION DES CLÃ‰S SÃ‰CURISÃ‰ES
# On les lit depuis les variables globales JS injectÃ©es par le HTML
P_UID = window.PROJECT_UID
TOKEN = window.STUDIO_TOKEN
APP_ROOT = document["app-root"]

print(f"ðŸš€ DÃ©marrage du Renderer pour le projet {P_UID}")

# ==========================================
# FONCTIONS DE RENDU (Moteur Graphique)
# ==========================================

def render_app(state):
    """
    Fonction principale qui dessine toute l'application
    """
    APP_ROOT.clear() # On efface le message "Chargement..."
    
    # Titre du projet
    h2 = document.createElement('h2')
    h2.text = f"Application: {state.get('app_meta', {}).get('name', 'Sans nom')}"
    APP_ROOT <= h2
    
    # Affichage des pages (Pour l'instant, juste la liste)
    pages = state.get('pages', [])
    if not pages:
        APP_ROOT <= document.createElement('div').text = "Aucune page dÃ©finie. Demandez Ã  l'IA d'en crÃ©er une !"
    else:
        for page in pages:
            p_div = document.createElement('div')
            p_div.style = {"border": "1px solid #ddd", "padding": "10px", "margin": "10px 0", "background": "white"}
            
            p_title = document.createElement('h3')
            p_title.text = f"ðŸ“„ Page: {page['name']}"
            p_div <= p_title
            
            # Affichage des composants de la page
            comps = page.get('components', [])
            if not comps:
                p_div <= document.createElement('em').text = "(Page vide)"
            else:
                ul = document.createElement('ul')
                for comp in comps:
                    li = document.createElement('li')
                    # On affiche juste le type pour l'instant (ex: "button")
                    li.text = f"ðŸ§© Composant: {comp['type']} (ID: {comp['id']})"
                    ul <= li
                p_div <= ul
                
            APP_ROOT <= p_div

# ==========================================
# COMMUNICATION AVEC LE SERVEUR (API)
# ==========================================

def on_load_success(req):
    """AppelÃ© quand le serveur rÃ©pond avec le JSON du projet"""
    try:
        data = json.loads(req.text)
        if data['status'] == 'success':
            # On rÃ©cupÃ¨re le JSON gÃ©ant (current_state)
            current_state = data['new_state']
            render_app(current_state)
        else:
            APP_ROOT.text = f"Erreur API : {data.get('msg')}"
    except Exception as e:
        APP_ROOT.text = f"Erreur JS : {str(e)}"

def load_project_state():
    """Demande l'Ã©tat actuel du projet au serveur"""
    # Pour lire l'Ã©tat, on envoie une liste d'actions vide []
    # Le moteur va juste renvoyer le 'current_state' sans rien modifier
    req = ajax.ajax()
    req.bind('complete', on_load_success)
    req.open('POST', '/yourfirstship/default/api_engine_execute', True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    
    # On envoie l'UID et le TOKEN de sÃ©curitÃ©
    body = f"project_uid={P_UID}&studio_token={TOKEN}&actions=[]"
    req.send(body)

# ==========================================
# DÃ‰MARRAGE
# ==========================================
load_project_state()

</script>