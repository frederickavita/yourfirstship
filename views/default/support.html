{{extend 'malayout.html'}}

<script id="initial-tickets" type="application/json">
    {{=XML(tickets_json)}}
</script>

<div class="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">

    {{include 'sidebar.html'}}

    <div class="flex-1 flex flex-col overflow-hidden relative">
        {{ page_title = "Support Uplink" }}
        {{include 'header.html'}}

        <main class="flex-1 flex overflow-hidden">
            
            <div class="w-80 bg-white border-r border-slate-200 flex flex-col hidden md:flex">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 text-sm uppercase tracking-wide">My Tickets</h2>
                    <button id="btn-new-ticket" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-md font-bold hover:bg-indigo-700 transition shadow-sm">
                        + New Request
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto" id="ticket-list-container">
                    </div>
            </div>

            <div class="flex-1 flex flex-col bg-slate-50 relative">
                
                <div id="chat-empty-state" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                    <div class="h-20 w-20 bg-white rounded-full flex items-center justify-center mb-6 shadow-sm border border-slate-100">
                        <i data-lucide="life-buoy" class="h-10 w-10 text-indigo-500"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Technical Support</h3>
                    <p class="text-slate-500 max-w-md mb-8">
                        Stuck on a feature? AI acting up? <br>
                        Contact our engineering team directly.
                    </p>
                    <button id="btn-new-ticket-hero" class="bg-white border border-slate-300 text-slate-700 px-6 py-2.5 rounded-lg font-bold hover:border-indigo-500 hover:text-indigo-600 transition">
                        Open New Ticket
                    </button>
                </div>

                <div id="chat-interface" class="hidden flex-1 flex flex-col h-full">
                    
                    <div class="h-16 bg-white border-b border-slate-200 flex items-center px-6 justify-between shrink-0">
                        <div>
                            <div class="flex items-center gap-3">
                                <h3 class="font-bold text-lg text-slate-800" id="current-ticket-subject">...</h3>
                                <span id="current-ticket-status" class="text-[10px] font-bold px-2 py-0.5 bg-amber-100 text-amber-700 rounded uppercase tracking-wider">Open</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-0.5">Ticket ID: <span id="current-ticket-id">#</span></p>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50" id="messages-container">
                        </div>

                    <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                        
                        <div id="form-new-ticket" class="hidden space-y-4 max-w-2xl mx-auto">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Subject</label>
                                <input type="text" id="inp-subject" placeholder="Ex: AI loop on database generation" class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                                <textarea id="inp-message-initial" rows="5" placeholder="Explain what happened. You can paste logs here." class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none"></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button id="btn-send-initial" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 flex items-center gap-2 shadow-md">
                                    Send Request <i data-lucide="send" class="h-4 w-4"></i> 
                                </button>
                            </div>
                        </div>
<div id="form-reply" class="hidden flex gap-2 max-w-4xl mx-auto w-full">
    <input type="text" id="inp-reply" placeholder="Type your response... (Use '/admin' to reply as Support)" class="flex-1 border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
    
    <button id="btn-send-reply" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm">
        <i data-lucide="send" class="h-5 w-5"></i>
    </button>
</div>
                        
                        <p class="text-center text-[10px] text-slate-400 mt-2">
                            Our engineers usually reply within 24 hours.
                        </p>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<script type="text/python">
from browser import document, html, window, ajax, timer
import json

URLS = {
    'create': "{{=URL('default', 'create_ticket')}}",
    'get_msgs': "{{=URL('default', 'get_ticket_messages')}}",
    'reply': "{{=URL('default', 'reply_to_ticket')}}"  # <-- NOUVELLE URL
}

app_state = {
    'tickets': [],
    'current_ticket_id': None
}

def init():
    try:
        app_state['tickets'] = json.loads(document['initial-tickets'].text)
    except:
        app_state['tickets'] = []

    document['btn-new-ticket'].bind('click', show_new_ticket_form)
    document['btn-new-ticket-hero'].bind('click', show_new_ticket_form)
    document['btn-send-initial'].bind('click', handle_create_ticket)
    
    # --- NOUVEAU BINDING ---
    document['btn-send-reply'].bind('click', handle_reply)
    # -----------------------

    render_ticket_list()
    if hasattr(window, 'lucide'): window.lucide.createIcons()

def render_ticket_list():
    container = document['ticket-list-container']
    container.clear()
    
    if not app_state['tickets']:
        container <= html.DIV("No tickets yet.", Class="p-4 text-sm text-slate-400 italic text-center")
        return

    for t in app_state['tickets']:
        is_active = (t['id'] == app_state['current_ticket_id'])
        bg_cls = "bg-indigo-50 border-r-4 border-indigo-600" if is_active else "hover:bg-slate-50 border-r-4 border-transparent"
        
        item = html.DIV(Class=f"p-4 cursor-pointer transition border-b border-slate-100 {bg_cls}")
        
        header = html.DIV(Class="flex justify-between items-start mb-1")
        header <= html.H4(t['subject'], Class="font-bold text-sm text-slate-800 truncate pr-2")
        header <= html.SPAN(t['date'], Class="text-[10px] text-slate-400 shrink-0")
        item <= header
        
        footer = html.DIV(Class="flex items-center gap-2")
        if t['status'] == 'open':
            s_cls = "bg-amber-100 text-amber-700"
        elif t['status'] == 'resolved':
            s_cls = "bg-green-100 text-green-700"
        else:
            s_cls = "bg-slate-100 text-slate-500"
            
        footer <= html.SPAN(t['status'], Class=f"text-[10px] font-bold uppercase px-1.5 py-0.5 rounded {s_cls}")
        footer <= html.SPAN(t['project'], Class="text-[10px] text-slate-500 truncate")
        item <= footer
        
        item.bind('click', lambda ev, tid=t['id']: load_ticket(tid))
        container <= item

def show_new_ticket_form(ev):
    app_state['current_ticket_id'] = None
    render_ticket_list()
    
    document['chat-empty-state'].classList.add('hidden')
    document['chat-interface'].classList.remove('hidden')
    
    document['current-ticket-subject'].text = "New Support Request"
    document['current-ticket-status'].classList.add('hidden')
    document['current-ticket-id'].text = "New"
    
    container = document['messages-container']
    container.clear()
    
    sys_msg = html.DIV(Class="flex justify-center my-4")
    sys_msg <= html.SPAN("Please describe your issue below.", Class="bg-slate-200 text-slate-600 text-xs px-3 py-1 rounded-full")
    container <= sys_msg
    
    document['form-new-ticket'].classList.remove('hidden')
    document['form-reply'].classList.add('hidden')

def handle_create_ticket(ev):
    subject = document['inp-subject'].value
    message = document['inp-message-initial'].value
    
    if not subject or not message:
        window.alert("Please fill all fields.")
        return
        
    btn = document['btn-send-initial']
    btn.text = "Sending..."
    btn.disabled = True
    
    req = ajax.ajax()
    req.bind('complete', on_create_complete)
    req.open('POST', URLS['create'], True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send({'subject': subject, 'message': message})

def on_create_complete(req):
    try:
        data = json.loads(req.text)
        if data['status'] == 'success':
            window.location.reload()
    except:
        window.alert("Error sending ticket.")
        document['btn-send-initial'].text = "Try Again"
        document['btn-send-initial'].disabled = False

def load_ticket(tid):
    app_state['current_ticket_id'] = tid
    render_ticket_list()
    
    document['chat-empty-state'].classList.add('hidden')
    document['chat-interface'].classList.remove('hidden')
    document['form-new-ticket'].classList.add('hidden')
    
    # ON AFFICHE LA BARRE DE RÉPONSE ICI
    document['form-reply'].classList.remove('hidden') 
    
    document['current-ticket-status'].classList.remove('hidden')
    document['current-ticket-id'].text = f"#{tid}"
    document['current-ticket-subject'].text = "Loading..."
    
    req = ajax.ajax()
    req.bind('complete', lambda r: render_conversation(r, tid))
    req.open('POST', URLS['get_msgs'], True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send({'ticket_id': tid})

def render_conversation(req, tid):
    data = json.loads(req.text)
    container = document['messages-container']
    container.clear()
    
    document['current-ticket-status'].text = data.get('ticket_status', 'open')
    
    subj = "Ticket"
    for t in app_state['tickets']:
        if t['id'] == tid:
            subj = t['subject']
            break
    document['current-ticket-subject'].text = subj
    
    if not data['messages']:
        container <= html.DIV("No messages yet.", Class="text-center text-slate-400 text-sm")
    
    for m in data['messages']:
        add_chat_bubble(m['sender'], m['content'], m['time'])
            
    container.scrollTop = container.scrollHeight

# --- NOUVELLE FONCTION DE RÉPONSE ---
def handle_reply(ev):
    inp = document['inp-reply']
    content = inp.value.strip()
    tid = app_state['current_ticket_id']
    
    if not content or not tid:
        return

    # On vide l'input tout de suite pour l'effet "Réactif"
    inp.value = ""
    
    req = ajax.ajax()
    req.bind('complete', lambda r: load_ticket(tid)) # On recharge la conversation après l'envoi
    req.open('POST', URLS['reply'], True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send({'ticket_id': tid, 'content': content})
# ------------------------------------

def add_chat_bubble(sender, text, time):
    container = document['messages-container']
    wrapper = html.DIV(Class="flex w-full mb-6")
    
    if sender == 'user':
        wrapper.classList.add("justify-end")
        bubble = html.DIV(Class="bg-indigo-600 text-white rounded-2xl rounded-tr-sm px-5 py-3 max-w-[80%] shadow-md relative group")
        meta = html.DIV(f"You • {time}", Class="text-[10px] text-indigo-200 mb-1")
        content = html.DIV(text, Class="text-sm leading-relaxed whitespace-pre-wrap")
        bubble <= meta
        bubble <= content
        wrapper <= bubble
        
    else: # Human Agent (Admin)
        wrapper.classList.add("justify-start")
        avatar = html.DIV(Class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center mr-3 border border-green-200 shrink-0")
        avatar <= html.I(**{'data-lucide': 'headset', 'class': 'h-4 w-4 text-green-600'})
        
        bubble = html.DIV(Class="bg-white border border-slate-200 text-slate-700 rounded-2xl rounded-tl-sm px-5 py-3 max-w-[80%] shadow-sm")
        meta = html.DIV(f"Support Engineer • {time}", Class="text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wide")
        content = html.DIV(text, Class="text-sm leading-relaxed whitespace-pre-wrap")
        
        bubble <= meta
        bubble <= content
        wrapper <= avatar
        wrapper <= bubble
        
    container <= wrapper

init()
</script>