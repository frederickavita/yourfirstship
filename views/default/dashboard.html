{{extend 'malayout.html'}}

<script id="initial-data" type="application/json">
    {{=XML(projects_json)}}
</script>

<div class="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">

{{include 'sidebar.html'}}
    <div class="flex-1 flex flex-col overflow-hidden relative">
 {{ page_title = "Mission Control" }}       
{{include 'header.html'}}
        <main class="flex-1 overflow-y-auto p-6 bg-slate-50 relative scroll-smooth">
            
            <div class="max-w-4xl mx-auto mb-10 pt-2"> <h2 class="text-xl font-bold text-slate-800 mb-1">Captain, what are we building today?</h2>
                <p class="text-xs text-slate-500 mb-6">Describe your vision. AI handles the architecture.</p>

                <div class="relative group z-10">
                    <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
                    
                    <div class="relative bg-white rounded-xl p-1.5 shadow-xl border border-slate-100 transition-all duration-300" id="launchpad-container">
                        
                        <textarea id="launchpad-input" rows="2" 
                                  class="w-full resize-none border-none focus:ring-0 text-slate-700 placeholder-slate-400 text-sm p-3 bg-transparent" 
                                  placeholder="I want a SaaS for [Target Audience] that allows them to [Core Feature]..."></textarea>
                        
                        <div class="flex flex-col sm:flex-row justify-between items-center px-2 pb-1 mt-1 border-t border-slate-50 pt-2 gap-4">
                            
                            <div class="flex flex-wrap gap-2" id="modifiers-container">
                                <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + SaaS Platform">
                                    <i data-lucide="plus" class="h-3 w-3"></i> SaaS
                                </button>
                                <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + Admin Dashboard">
                                    <i data-lucide="plus" class="h-3 w-3"></i> Admin
                                </button>
                                <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + Mobile App">
                                    <i data-lucide="plus" class="h-3 w-3"></i> Mobile
                                </button>
                                 <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-2.5 py-0.5 rounded-full text-[10px] font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + Stripe Payments">
                                    <i data-lucide="plus" class="h-3 w-3"></i> Stripe
                                </button>
                            </div>

                            <button id="ignite-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2 text-xs">
                                <i data-lucide="flame" class="h-3 w-3"></i> Ignite Engines
                            </button>
                        </div>
                    </div>
                </div>

                <div id="narrative-feedback" class="hidden mt-4 bg-slate-900 rounded-xl p-4 border border-slate-800 shadow-2xl relative overflow-hidden animate-in fade-in slide-in-from-top-4 duration-500">
                     <div class="absolute top-0 left-0 h-1 bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300 ease-out" id="narrative-progress" style="width: 0%"></div>

                     <div class="flex items-center gap-3">
                         <div class="h-8 w-8 rounded-full bg-indigo-500/20 flex items-center justify-center relative">
                             <div class="absolute inset-0 rounded-full bg-indigo-500 opacity-20 animate-ping"></div>
                             <i data-lucide="cpu" class="h-4 w-4 text-indigo-400 relative z-10"></i>
                         </div>
                         <div>
                             <h4 class="text-indigo-400 font-mono text-[10px] font-bold uppercase tracking-widest mb-0.5">System Status</h4>
                             <p class="text-slate-200 font-mono text-xs tracking-wide" id="narrative-text">Initializing sequence...</p>
                         </div>
                     </div>
                </div>
            </div>


            <div class="flex flex-wrap items-center gap-6 border-b border-slate-200 mb-6" id="tabs-container">
                </div>

            <div id="skeleton-loader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {{for i in range(3):}}
                <div class="bg-white rounded-xl border border-slate-200 p-4 h-48 animate-pulse flex flex-col gap-3">
                    <div class="flex justify-between">
                        <div class="h-10 w-10 bg-slate-200 rounded-lg"></div>
                        <div class="h-5 w-20 bg-slate-200 rounded"></div>
                    </div>
                    <div class="h-5 bg-slate-200 rounded w-3/4 mt-2"></div>
                    <div class="h-3 bg-slate-200 rounded w-full"></div>
                    <div class="h-3 bg-slate-200 rounded w-1/2"></div>
                </div>
                {{pass}}
            </div>

            <div id="project-container" class="hidden"></div>

        </main>
    </div>
</div>

<div id="toast-notification" class="fixed bottom-6 right-6 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 transform translate-y-32 transition-transform duration-300 z-50">
    <div class="flex items-center gap-2">
        <i data-lucide="archive" class="h-4 w-4 text-amber-400"></i>
        <span class="font-bold text-sm">Action successful.</span>
    </div>
    <button id="undo-btn" class="text-indigo-300 font-bold hover:text-white underline text-xs">Undo</button>
</div>


<script type="text/python">
from browser import document, html, window, ajax, timer
import json

# --- CONFIG ---
URLS = {
    'holodeck': "{{=URL('the_holodeck')}}",
    'create': "{{=URL('default', 'create_project')}}",
    'deploy': "{{=URL('default', 'toggle_deploy')}}",
    'treasury': "{{=URL('treasury')}}"
}

# --- STATE ---
app_state = {
    'projects': [],
    'filter_text': '',
    'current_tab': 'active', 
    'last_archived_id': None,
    'open_menu_id': None,
    'modifiers': []
}

def init():
    try:
        app_state['projects'] = json.loads(document['initial-data'].text)
    except:
        app_state['projects'] = []

    document['undo-btn'].bind('click', handle_undo)
    document.bind('click', handle_global_click)

    document['ignite-btn'].bind('click', handle_ignite)
    for btn in document.select('.modifier-btn'):
        btn.bind('click', handle_modifier)

    render_tabs()
    timer.set_timeout(finalize_loading, 100)

def finalize_loading():
    document['skeleton-loader'].classList.add('hidden')
    c = document['project-container']
    c.classList.remove('hidden')
    c.classList.add('animate-fade-in')
    render_projects()

def handle_modifier(ev):
    btn = ev.currentTarget
    tag = btn.attrs.get('data-add', '').strip()
    
    if tag in app_state['modifiers']:
        app_state['modifiers'].remove(tag)
        btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200')
        btn.classList.add('bg-slate-100', 'text-slate-600')
    else:
        app_state['modifiers'].append(tag)
        btn.classList.remove('bg-slate-100', 'text-slate-600')
        btn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-200')

def handle_ignite(ev):
    prompt = document['launchpad-input'].value.strip()
    
    if not prompt:
        document['launchpad-input'].classList.add('ring-2', 'ring-red-500')
        timer.set_timeout(lambda: document['launchpad-input'].classList.remove('ring-2', 'ring-red-500'), 1000)
        return

    document['launchpad-input'].disabled = True
    document['ignite-btn'].disabled = True
    document['ignite-btn'].classList.add('opacity-50', 'cursor-not-allowed')
    document['ignite-btn'].text = "Igniting..."
    
    fb = document['narrative-feedback']
    fb.classList.remove('hidden')
    
    run_narrative_sequence(0)

    req = ajax.ajax()
    req.bind('complete', on_creation_complete)
    req.open('POST', URLS['create'], True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send({'prompt': prompt, 'modifiers[]': app_state['modifiers']})

def run_narrative_sequence(step_idx):
    steps = [
        ("Analysis confirmed. Intent detected.", 20),
        ("Allocating credits...", 40),
        ("Drafting database schema...", 60),
        ("Compiling modules...", 80),
        ("Finalizing environment...", 90)
    ]
    if step_idx < len(steps):
        text, percent = steps[step_idx]
        document['narrative-text'].text = text
        document['narrative-progress'].style.width = f"{percent}%"
        timer.set_timeout(lambda: run_narrative_sequence(step_idx + 1), 500)

def on_creation_complete(req):
    try:
        data = json.loads(req.text)
        if data.get('status') == 'error':
            window.alert(data['message'])
            if "Fuel" in data['message']:
                window.location.href = URLS['treasury']
            return

        document['narrative-text'].text = "Ready. Ship Launched."
        document['narrative-progress'].style.width = "100%"
        timer.set_timeout(lambda: finalize_creation_ui(data['project']), 800)
        
    except Exception as e:
        print(e)
        window.alert("Critical error connecting to HQ.")
        reset_launchpad()

def finalize_creation_ui(new_project):
    app_state['projects'].insert(0, new_project)
    reset_launchpad()
    render_projects()
    show_toast(f"Ship '{new_project['title']}' initialized!")

def reset_launchpad():
    document['launchpad-input'].value = ""
    document['launchpad-input'].disabled = False
    document['ignite-btn'].disabled = False
    document['ignite-btn'].classList.remove('opacity-50', 'cursor-not-allowed')
    document['ignite-btn'].text = "Ignite Engines"
    document['narrative-feedback'].classList.add('hidden')
    document['narrative-progress'].style.width = "0%"
    app_state['modifiers'] = []
    for btn in document.select('.modifier-btn'):
        btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200')
        btn.classList.add('bg-slate-100', 'text-slate-600')

def handle_deploy(ev):
    ev.stopPropagation()
    btn = ev.currentTarget 
    pid = btn.attrs.get('data-pid')

    if not pid:
        window.alert("Erreur: ID projet introuvable sur le bouton")
        return

    btn.text = "..."
    req = ajax.ajax()
    req.bind('complete', lambda r: on_deploy_complete(r, pid)) 
    req.open('POST', URLS['deploy'], True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send({'project_id': pid})

def on_deploy_complete(req, pid):
    try:
        data = json.loads(req.text)
        if data['status'] == 'error':
            window.alert(data['message'])
            if "fuel" in data['message'].lower():
                window.location.href = URLS['treasury']
            return
            
        for p in app_state['projects']:
            if p['id'] == pid:
                p['status'] = data['new_status']
                break
        
        show_toast(data['message'])
        render_projects() 
        
    except Exception as e:
        print(e)
        window.alert("Comms error.")

def set_tab(ev, tab_name):
    app_state['current_tab'] = tab_name
    render_tabs()    
    render_projects() 

def render_tabs():
    container = document['tabs-container']
    container.clear()
    
    tabs = [('active', 'Active Fleet', 'ship'), ('archived', 'Dry Dock (Archives)', 'archive')]
    
    for tab_id, label, icon in tabs:
        is_active = (app_state['current_tab'] == tab_id)
        base_cls = "flex items-center gap-2 pb-2 text-xs font-medium transition-colors border-b-2 cursor-pointer" # pb-3->pb-2, text-sm->text-xs
        active_cls = "border-indigo-600 text-indigo-600"
        inactive_cls = "border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300"
        
        btn = html.DIV(Class=f"{base_cls} {active_cls if is_active else inactive_cls}")
        btn <= html.I(**{'data-lucide': icon, 'class': 'h-3.5 w-3.5'})
        btn <= label
        
        count = len([p for p in app_state['projects'] if (p['status'] == 'archived') == (tab_id == 'archived')])
        btn <= html.SPAN(str(count), Class="bg-slate-100 text-slate-600 py-0.5 px-1.5 rounded-full text-[10px] ml-1")

        btn.bind('click', lambda ev, t=tab_id: set_tab(ev, t))
        container <= btn

    # SEARCH INPUT COMPACT
    search_wrapper = html.DIV(Class="ml-auto relative group")
    icon_div = html.DIV(Class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none")
    icon_div <= html.I(**{'data-lucide': 'search', 'class': 'h-3.5 w-3.5 text-slate-400 group-focus-within:text-indigo-500 transition-colors'})
    search_wrapper <= icon_div
    
    search_inp = html.INPUT(Type="text", Id="project-search-input", 
        Class="block w-48 pl-8 pr-2 py-1.5 border border-slate-200 rounded-lg text-xs bg-slate-50 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all",
        Placeholder="Filter fleet...")
    
    search_inp.bind('input', handle_search)
    if app_state['filter_text']:
        search_inp.value = app_state['filter_text']
        
    search_wrapper <= search_inp
    container <= search_wrapper
        
    if hasattr(window, 'lucide'): window.lucide.createIcons()

def handle_search(ev):
    app_state['filter_text'] = ev.target.value.lower()
    render_projects()

def handle_global_click(ev):
    if app_state['open_menu_id'] is not None:
        elt = ev.target
        is_in_menu = False
        while elt.parent:
            if 'dropdown-btn' in elt.classList or 'dropdown-menu' in elt.classList:
                is_in_menu = True
                break
            elt = elt.parent
        if not is_in_menu:
            app_state['open_menu_id'] = None
            render_projects()

def toggle_menu(ev, pid):
    ev.stopPropagation()
    app_state['open_menu_id'] = pid if app_state['open_menu_id'] != pid else None
    render_projects()

def handle_archive(ev):
    ev.stopPropagation()
    btn = ev.currentTarget
    pid = btn.attrs.get('data-pid')
    
    for p in app_state['projects']:
        if str(p['id']) == str(pid):
            new_status = 'archived' if p['status'] != 'archived' else 'draft'
            p['status'] = new_status
            app_state['last_archived_id'] = p['id']
            msg = "Project sent to Dry Dock." if new_status == 'archived' else "Project restored."
            show_toast(msg)
            break
            
    app_state['open_menu_id'] = None
    render_tabs()     
    render_projects()

def handle_undo(ev):
    pid = app_state['last_archived_id']
    if pid:
        for p in app_state['projects']:
            if p['id'] == pid:
                p['status'] = 'draft' if p['status'] == 'archived' else 'archived'
                break
    hide_toast()
    render_tabs()
    render_projects()

def show_toast(msg):
    t = document['toast-notification']
    t.select_one('span').text = msg
    t.style.transform = "translateY(0)"
    timer.set_timeout(hide_toast, 5000)

def hide_toast():
    document['toast-notification'].style.transform = "translateY(8rem)"

def render_projects():
    container = document['project-container']
    container.clear()
    term = app_state['filter_text']
    current_tab = app_state['current_tab']
    to_show = []
    
    for p in app_state['projects']:
        is_archived = (p['status'] == 'archived')
        if current_tab == 'active' and is_archived: continue
        if current_tab == 'archived' and not is_archived: continue
        if term and (term not in p['title'].lower() and term not in p['status'].lower()): continue
        to_show.append(p)

    if not to_show:
        render_empty_state(container, current_tab)
    else:
        grid = html.DIV(Class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 projects-grid animate-fade-in") # gap-6->gap-4
        for p in to_show:
            grid <= create_no_image_card(p)
        container <= grid
    if hasattr(window, 'lucide'): window.lucide.createIcons()

def render_empty_state(container, tab):
    msg = "No active ships found." if tab == 'active' else "Dry dock is empty."
    wrapper = html.DIV(Class="flex flex-col items-center justify-center h-48 text-center border-2 border-dashed border-slate-200 rounded-xl")
    wrapper <= html.H3(msg, Class="text-sm font-bold text-slate-500")
    container <= wrapper


def create_no_image_card(p):
    # Padding réduit p-6 -> p-4
    card = html.DIV(Class="group bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-lg hover:border-indigo-300 transition-all duration-300 flex flex-col overflow-hidden relative")
    
    if p['status'] == 'deployed':
        bg_color = "bg-green-500"
        status_text = "Deployed"
        status_cls = "text-green-600 bg-green-50"
    elif p['status'] == 'archived':
        bg_color = "bg-slate-500"
        status_text = "Archived"
        status_cls = "text-slate-500 bg-slate-100"
    else:
        bg_color = "bg-amber-500"
        status_text = "Draft"
        status_cls = "text-amber-600 bg-amber-50"

    header_strip = html.DIV(Class=f"h-1.5 w-full {bg_color}") # h-2 -> h-1.5
    card <= header_strip

    body = html.DIV(Class="p-4 flex-1 flex flex-col") # p-6 -> p-4 (PLUS COMPACT)
    
    # 2. LIGNE DU HAUT
    top_row = html.DIV(Class="flex items-start gap-3 mb-3")
    
    # Icône réduite h-12->h-10
    icon_box = html.DIV(Class=f"h-10 w-10 rounded-lg {bg_color} bg-opacity-10 flex items-center justify-center shrink-0")
    icon_box <= html.I(**{'data-lucide': 'rocket', 'class': f"h-5 w-5 {bg_color.replace('bg-', 'text-')}"})
    top_row <= icon_box
    
    title_col = html.DIV(Class="flex-1 min-w-0")
    # Titre réduit text-lg -> text-sm
    title_col <= html.H3(p['title'], Class="font-bold text-sm text-slate-800 truncate group-hover:text-indigo-600 transition-colors")
    title_col <= html.SPAN(status_text, Class=f"text-[9px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded mt-0.5 inline-block {status_cls}")
    top_row <= title_col
    
    body <= top_row

    # 3. ZONE DES BOUTONS
    actions_row = html.DIV(Class="flex items-center justify-end gap-2 mt-1")

    if p['status'] == 'archived':
        lbl_arch = "Restaurer"
        cls_arch = "bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border-indigo-200"
        ico_arch = "refresh-ccw"
    else:
        lbl_arch = "Archiver"
        cls_arch = "bg-slate-100 text-slate-600 hover:bg-slate-200 border-slate-200"
        ico_arch = "archive"

    # Boutons plus petits py-1 -> py-0.5
    btn_arch = html.BUTTON(Class=f"{cls_arch} px-2.5 py-0.5 rounded-md text-[10px] font-bold border transition flex items-center gap-1")
    btn_arch <= html.I(**{'data-lucide': ico_arch, 'class': 'h-3 w-3'})
    btn_arch <= lbl_arch
    btn_arch.attrs['data-pid'] = str(p['id'])
    btn_arch.bind('click', handle_archive)
    
    actions_row <= btn_arch

    if p['status'] == 'deployed':
        btn_deploy = html.BUTTON(Class="bg-red-50 text-red-600 hover:bg-red-100 px-2.5 py-0.5 rounded-md text-[10px] font-bold border border-red-200 transition flex items-center gap-1")
        btn_deploy <= html.I(**{'data-lucide': 'power-off', 'class': 'h-3 w-3'})
        btn_deploy <= "Stop"
    else:
        btn_deploy = html.BUTTON(Class="bg-green-50 text-green-600 hover:bg-green-100 px-2.5 py-0.5 rounded-md text-[10px] font-bold border border-green-200 transition flex items-center gap-1")
        btn_deploy <= html.I(**{'data-lucide': 'rocket', 'class': 'h-3 w-3'})
        btn_deploy <= "Launch"
    
    btn_deploy.attrs['data-pid'] = str(p['id'])
    btn_deploy.bind('click', handle_deploy)
    
    actions_row <= btn_deploy

    menu_btn = html.BUTTON(Class="text-slate-400 hover:text-slate-600 p-0.5 rounded hover:bg-slate-100 transition dropdown-btn ml-1")
    menu_btn <= html.I(**{'data-lucide': 'more-vertical', 'class': 'h-4 w-4'})
    menu_btn.bind('click', lambda ev, pid=p['id']: toggle_menu(ev, pid))
    actions_row <= menu_btn

    body <= actions_row

    # 4. PROGRÈS & META
    progress_label = html.DIV(Class="flex justify-between text-[10px] text-slate-500 mb-1 mt-3")
    progress_label <= html.SPAN("Integrity")
    progress_label <= html.SPAN("100%")
    body <= progress_label
    progress_track = html.DIV(Class="h-1 w-full bg-slate-100 rounded-full overflow-hidden mb-3")
    progress_fill = html.DIV(Class=f"h-full {bg_color} w-full")
    progress_track <= progress_fill
    body <= progress_track

    meta = html.DIV(Class="text-[10px] text-slate-500 flex flex-col gap-0.5 mt-auto pt-3 border-t border-slate-50")
    meta <= html.SPAN(f"ID: {p['uid'] if 'uid' in p else 'Unknown'}")
    meta <= html.SPAN(f"Created: {p['date'] if 'date' in p else 'Just now'}")
    body <= meta

    card <= body

    if app_state['open_menu_id'] == p['id']:
        dd = html.DIV(Class="absolute right-4 top-28 w-40 bg-white rounded-lg shadow-xl border border-slate-100 z-50 py-1 text-xs animate-in fade-in zoom-in-95 dropdown-menu")
        
        btn_open = html.A(Class="w-full text-left px-3 py-1.5 text-slate-700 hover:bg-slate-50 flex items-center gap-2", href=f"#")
        btn_open <= html.I(**{'data-lucide': 'external-link', 'class': 'h-3.5 w-3.5'})
        btn_open <= "Open Studio"
        
        btn_del = html.BUTTON(Class="w-full text-left px-3 py-1.5 text-red-600 hover:bg-red-50 flex items-center gap-2")
        btn_del <= html.I(**{'data-lucide': 'trash-2', 'class': 'h-3.5 w-3.5'})
        btn_del <= "Delete Ship"
        
        dd <= btn_open
        dd <= btn_del
        card <= dd

    return card

init()
</script>

<style>
    .animate-fade-in { animation: fadeInUp 0.5s ease-out forwards; }
    .animate-in { animation: fadeInUp 0.5s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>