{{extend 'malayout.html'}}

<script id="initial-data" type="application/json">
    {{=XML(projects_json)}}
</script>

<div class="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">

    <aside class="w-64 bg-slate-900 text-slate-300 hidden md:flex flex-col border-r border-slate-800">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <i data-lucide="ship" class="text-indigo-500 h-6 w-6 mr-3"></i>
            <span class="font-bold text-white text-lg tracking-tight">YourFirstShip</span>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <a href="{{=URL('dashboard')}}" class="flex items-center gap-3 px-4 py-3 bg-indigo-600/10 text-indigo-400 rounded-lg border border-indigo-600/20">
                <i data-lucide="layout-grid" class="h-5 w-5"></i><span class="font-medium">Dashboard</span>
            </a>
            <a href="{{=URL('treasury')}}" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-800 hover:text-white rounded-lg transition-colors">
                <i data-lucide="wallet" class="h-5 w-5"></i><span class="font-medium">Trésorerie</span>
            </a>
            <a href="{{=URL('support')}}" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-800 hover:text-white rounded-lg transition-colors">
                <i data-lucide="life-buoy" class="h-5 w-5"></i><span class="font-medium">Support</span>
            </a>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-xs">{{=user.first_name[0]}}</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-medium text-white truncate">{{=user.first_name}}</p>
                    <a href="{{=URL('user','profile')}}" class="text-xs text-slate-500 hover:text-indigo-400">Voir Profil</a>
                </div>
            </div>
            <a href="{{=URL('user', args='logout')}}" class="flex items-center gap-2 text-xs text-slate-500 hover:text-red-400 px-2 transition-colors">
                <i data-lucide="log-out" class="h-3 w-3"></i> Déconnexion
            </a>
        </div>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden relative">
        
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 z-20 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-bold text-slate-800">Mission Control</h1>
                <div class="flex items-center gap-1.5 px-2 py-0.5 bg-green-50 rounded-full border border-green-100">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span class="text-[10px] font-bold text-green-700 uppercase tracking-wide">Online</span>
                </div>
            </div>
            </header>

        <main class="flex-1 overflow-y-auto p-8 bg-slate-50 relative scroll-smooth">
            
            <div class="max-w-4xl mx-auto mb-16 pt-4">
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Captain, what are we building today?</h2>
                <p class="text-slate-500 mb-8">Describe your vision. AI handles the architecture.</p>

                <div class="relative group z-10">
                    <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
                    
                    <div class="relative bg-white rounded-xl p-2 shadow-xl border border-slate-100 transition-all duration-300" id="launchpad-container">
                        
                        <textarea id="launchpad-input" rows="2" 
                                  class="w-full resize-none border-none focus:ring-0 text-slate-700 placeholder-slate-400 text-lg p-4 bg-transparent" 
                                  placeholder="I want a SaaS for [Target Audience] that allows them to [Core Feature]..."></textarea>
                        
                        <div class="flex flex-col sm:flex-row justify-between items-center px-2 pb-2 mt-2 border-t border-slate-50 pt-3 gap-4">
                            
                            <div class="flex flex-wrap gap-2" id="modifiers-container">
                                <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-full text-xs font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + SaaS Platform">
                                    <i data-lucide="plus" class="h-3 w-3"></i> SaaS
                                </button>
                                <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-full text-xs font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + Admin Dashboard">
                                    <i data-lucide="plus" class="h-3 w-3"></i> Admin
                                </button>
                                <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-full text-xs font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + Mobile App">
                                    <i data-lucide="plus" class="h-3 w-3"></i> Mobile
                                </button>
                                 <button class="modifier-btn bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-full text-xs font-bold transition flex items-center gap-1 border border-transparent hover:border-indigo-100" data-add=" + Stripe Payments">
                                    <i data-lucide="plus" class="h-3 w-3"></i> Stripe
                                </button>
                            </div>

                            <button id="ignite-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                <i data-lucide="flame" class="h-4 w-4"></i> Ignite Engines
                            </button>
                        </div>
                    </div>
                </div>

                <div id="narrative-feedback" class="hidden mt-6 bg-slate-900 rounded-xl p-6 border border-slate-800 shadow-2xl relative overflow-hidden animate-in fade-in slide-in-from-top-4 duration-500">
                     <div class="absolute top-0 left-0 h-1 bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300 ease-out" id="narrative-progress" style="width: 0%"></div>

                     <div class="flex items-center gap-4">
                         <div class="h-10 w-10 rounded-full bg-indigo-500/20 flex items-center justify-center relative">
                             <div class="absolute inset-0 rounded-full bg-indigo-500 opacity-20 animate-ping"></div>
                             <i data-lucide="cpu" class="h-5 w-5 text-indigo-400 relative z-10"></i>
                         </div>
                         <div>
                             <h4 class="text-indigo-400 font-mono text-xs font-bold uppercase tracking-widest mb-1">System Status</h4>
                             <p class="text-slate-200 font-mono text-sm tracking-wide" id="narrative-text">Initializing sequence...</p>
                         </div>
                     </div>
                </div>
            </div>


            <div class="flex flex-wrap items-center gap-6 border-b border-slate-200 mb-8" id="tabs-container">
                </div>

            <div id="skeleton-loader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {{for i in range(3):}}
                <div class="bg-white rounded-xl border border-slate-200 p-6 h-64 animate-pulse flex flex-col gap-4">
                    <div class="flex justify-between">
                        <div class="h-12 w-12 bg-slate-200 rounded-lg"></div>
                        <div class="h-6 w-24 bg-slate-200 rounded"></div>
                    </div>
                    <div class="h-6 bg-slate-200 rounded w-3/4 mt-4"></div>
                    <div class="h-4 bg-slate-200 rounded w-full"></div>
                    <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                </div>
                {{pass}}
            </div>

            <div id="project-container" class="hidden"></div>

        </main>
    </div>
</div>

<div id="toast-notification" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-4 transform translate-y-32 transition-transform duration-300 z-50">
    <div class="flex items-center gap-2">
        <i data-lucide="archive" class="h-5 w-5 text-amber-400"></i>
        <span>Action successful.</span>
    </div>
    <button id="undo-btn" class="text-indigo-300 font-bold hover:text-white underline text-sm">Undo</button>
</div>


<script type="text/python">
from browser import document, html, window, timer
import json

# --- CONFIG ---
URLS = {
    'holodeck': "{{=URL('the_holodeck')}}",
    'narrative': "{{=URL('narrative_engine')}}" 
}

# --- STATE ---
app_state = {
    'projects': [],
    'filter_text': '',
    'current_tab': 'active', 
    'last_archived_id': None,
    'open_menu_id': None,
    # Launchpad State
    'narrative_step': 0
}

def init():
    # 1. Chargement Données
    try:
        app_state['projects'] = json.loads(document['initial-data'].text)
    except:
        app_state['projects'] = []

    # 2. Bindings Flotte
    # L'input n'existe pas encore au chargement initial car généré par render_tabs
    # On le bindera dans render_tabs
    document['undo-btn'].bind('click', handle_undo)
    document.bind('click', handle_global_click)

    # 3. Bindings Launchpad
    document['ignite-btn'].bind('click', handle_ignite)
    for btn in document.select('.modifier-btn'):
        btn.bind('click', handle_modifier)

    # 4. Rendu Initial
    render_tabs()
    timer.set_timeout(finalize_loading, 600)

def finalize_loading():
    document['skeleton-loader'].classList.add('hidden')
    c = document['project-container']
    c.classList.remove('hidden')
    c.classList.add('animate-fade-in')
    render_projects()


# ============================================================
# LOGIQUE LAUNCHPAD
# ============================================================

def handle_modifier(ev):
    target = ev.target
    while target.tagName != 'BUTTON':
        target = target.parent
    text_to_add = target.attrs.get('data-add', '')
    input_box = document['launchpad-input']
    input_box.value += text_to_add
    input_box.focus()

def handle_ignite(ev):
    input_val = document['launchpad-input'].value.strip()
    if not input_val:
        document['launchpad-input'].classList.add('ring-2', 'ring-red-500')
        timer.set_timeout(lambda: document['launchpad-input'].classList.remove('ring-2', 'ring-red-500'), 1000)
        return

    document['launchpad-input'].disabled = True
    document['ignite-btn'].disabled = True
    document['ignite-btn'].classList.add('opacity-50', 'cursor-not-allowed')
    document['ignite-btn'].text = "Engines Running..."
    
    fb = document['narrative-feedback']
    fb.classList.remove('hidden')
    
    run_narrative_sequence()

def run_narrative_sequence():
    steps = [
        ("Analysis confirmed. Intent detected.", 20),
        ("Drafting database schema...", 45),
        ("Compiling Python logic modules...", 70),
        ("Finalizing Holodeck environment...", 90),
        ("Ready. Handoff to Studio.", 100)
    ]
    
    step_idx = app_state['narrative_step']
    
    if step_idx < len(steps):
        text, percent = steps[step_idx]
        document['narrative-text'].text = text
        document['narrative-progress'].style.width = f"{percent}%"
        app_state['narrative_step'] += 1
        timer.set_timeout(run_narrative_sequence, 800)
    else:
        window.location.href = URLS['narrative']


# ============================================================
# LOGIQUE FLOTTE
# ============================================================

def set_tab(ev, tab_name):
    app_state['current_tab'] = tab_name
    render_tabs()    
    render_projects() 

def render_tabs():
    container = document['tabs-container']
    container.clear()
    
    # 1. RENDU DES ONGLETS
    tabs = [('active', 'Active Fleet', 'ship'), ('archived', 'Dry Dock (Archives)', 'archive')]
    
    for tab_id, label, icon in tabs:
        is_active = (app_state['current_tab'] == tab_id)
        base_cls = "flex items-center gap-2 pb-3 text-sm font-medium transition-colors border-b-2 cursor-pointer"
        active_cls = "border-indigo-600 text-indigo-600"
        inactive_cls = "border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300"
        
        btn = html.DIV(Class=f"{base_cls} {active_cls if is_active else inactive_cls}")
        btn <= html.I(**{'data-lucide': icon, 'class': 'h-4 w-4'})
        btn <= label
        
        count = len([p for p in app_state['projects'] if (p['status'] == 'archived') == (tab_id == 'archived')])
        btn <= html.SPAN(str(count), Class="bg-slate-100 text-slate-600 py-0.5 px-2 rounded-full text-xs ml-1")

        btn.bind('click', lambda ev, t=tab_id: set_tab(ev, t))
        container <= btn

    # 2. RENDU DE L'INPUT RECHERCHE (FLOAT RIGHT via ml-auto)
    search_wrapper = html.DIV(Class="ml-auto relative group")
    
    icon_div = html.DIV(Class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none")
    icon_div <= html.I(**{'data-lucide': 'search', 'class': 'h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors'})
    search_wrapper <= icon_div
    
    search_inp = html.INPUT(Type="text", Id="project-search-input", 
        Class="block w-64 pl-10 pr-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all",
        Placeholder="Filter fleet...")
    
    # On bind l'event ici car l'élément vient d'être créé
    search_inp.bind('input', handle_search)
    
    # Restaurer la valeur si elle existe
    if app_state['filter_text']:
        search_inp.value = app_state['filter_text']
        
    search_wrapper <= search_inp
    container <= search_wrapper
        
    if hasattr(window, 'lucide'): window.lucide.createIcons()

def handle_search(ev):
    app_state['filter_text'] = ev.target.value.lower()
    render_projects()

def handle_global_click(ev):
    if app_state['open_menu_id'] is not None:
        elt = ev.target
        is_in_menu = False
        while elt.parent:
            if 'dropdown-btn' in elt.classList or 'dropdown-menu' in elt.classList:
                is_in_menu = True
                break
            elt = elt.parent
        if not is_in_menu:
            app_state['open_menu_id'] = None
            render_projects()

def toggle_menu(ev, pid):
    ev.stopPropagation()
    app_state['open_menu_id'] = pid if app_state['open_menu_id'] != pid else None
    render_projects()

def archive_project_action(ev, pid):
    if ev: ev.stopPropagation()
    for p in app_state['projects']:
        if p['id'] == pid:
            new_status = 'archived' if p['status'] != 'archived' else 'draft'
            p['status'] = new_status
            app_state['last_archived_id'] = pid
            break
    app_state['open_menu_id'] = None
    show_toast()
    render_tabs()     
    render_projects() 

def handle_undo(ev):
    pid = app_state['last_archived_id']
    if pid:
        for p in app_state['projects']:
            if p['id'] == pid:
                p['status'] = 'draft' if p['status'] == 'archived' else 'archived'
                break
    hide_toast()
    render_tabs()
    render_projects()

def show_toast():
    t = document['toast-notification']
    t.style.transform = "translateY(0)"
    timer.set_timeout(hide_toast, 5000)

def hide_toast():
    document['toast-notification'].style.transform = "translateY(8rem)"

def render_projects():
    container = document['project-container']
    container.clear()
    term = app_state['filter_text']
    current_tab = app_state['current_tab']
    to_show = []
    for p in app_state['projects']:
        is_archived = (p['status'] == 'archived')
        if current_tab == 'active' and is_archived: continue
        if current_tab == 'archived' and not is_archived: continue
        if term and (term not in p['title'].lower() and term not in p['status'].lower()):
            continue
        to_show.append(p)

    if not to_show:
        render_empty_state(container, current_tab)
    else:
        grid = html.DIV(Class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 projects-grid")
        for p in to_show:
            grid <= create_no_image_card(p)
        container <= grid
    if hasattr(window, 'lucide'): window.lucide.createIcons()

def render_empty_state(container, tab):
    msg = "No active ships found." if tab == 'active' else "Dry dock is empty."
    wrapper = html.DIV(Class="flex flex-col items-center justify-center h-64 text-center animate-fade-in-up border-2 border-dashed border-slate-200 rounded-xl")
    wrapper <= html.H3(msg, Class="text-lg font-bold text-slate-500")
    container <= wrapper

def create_no_image_card(p):
    card = html.DIV(Class="group bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-lg hover:border-indigo-300 transition-all duration-300 flex flex-col overflow-hidden relative")
    
    bg_color = "bg-indigo-500" if p['status'] == 'deployed' else "bg-slate-500" if p['status'] == 'archived' else "bg-amber-500"
    header_strip = html.DIV(Class=f"h-2 w-full {bg_color}")
    card <= header_strip

    body = html.DIV(Class="p-6 flex-1 flex flex-col")
    
    top_row = html.DIV(Class="flex items-start gap-4 mb-4")
    icon_box = html.DIV(Class=f"h-12 w-12 rounded-lg {bg_color} bg-opacity-10 flex items-center justify-center shrink-0")
    icon_box <= html.I(**{'data-lucide': 'box', 'class': f"h-6 w-6 {bg_color.replace('bg-', 'text-')}"})
    top_row <= icon_box
    
    title_col = html.DIV(Class="flex-1 min-w-0")
    title_col <= html.H3(p['title'], Class="font-bold text-lg text-slate-800 truncate group-hover:text-indigo-600 transition-colors")
    if p['status'] == 'deployed':
        badge = html.SPAN("Deployed", Class="text-xs font-bold text-green-600 flex items-center gap-1 mt-1")
    elif p['status'] == 'archived':
        badge = html.SPAN("Archived", Class="text-xs font-bold text-slate-400 mt-1")
    else:
        badge = html.SPAN("Draft Mode", Class="text-xs font-bold text-amber-600 mt-1")
    title_col <= badge
    top_row <= title_col

    # --- BOUTON TEXTE ---
    is_arch = (p['status'] == 'archived')
    if is_arch:
        btn_label = "Restaurer"
        btn_cls = "bg-green-100 text-green-700 hover:bg-green-200 border-green-200"
    else:
        btn_label = "Archiver"
        btn_cls = "bg-amber-100 text-amber-700 hover:bg-amber-200 border-amber-200"

    quick_btn = html.BUTTON(Class=f"{btn_cls} px-3 py-1 rounded-md transition mr-2 shrink-0 text-xs font-bold border shadow-sm flex items-center")
    quick_btn <= btn_label
    quick_btn.bind('click', lambda ev, pid=p['id']: archive_project_action(ev, pid))
    top_row <= quick_btn

    menu_btn = html.BUTTON(Class="text-slate-400 hover:text-slate-600 p-1 rounded hover:bg-slate-100 transition dropdown-btn shrink-0")
    menu_btn <= html.I(**{'data-lucide': 'more-vertical', 'class': 'h-5 w-5'})
    menu_btn.bind('click', lambda ev, pid=p['id']: toggle_menu(ev, pid))
    top_row <= menu_btn
    
    body <= top_row

    progress_label = html.DIV(Class="flex justify-between text-xs text-slate-500 mb-1")
    progress_label <= html.SPAN("System Integrity")
    progress_label <= html.SPAN("94%")
    body <= progress_label
    progress_track = html.DIV(Class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden mb-4")
    progress_fill = html.DIV(Class=f"h-full {bg_color} w-[94%]")
    progress_track <= progress_fill
    body <= progress_track

    meta = html.DIV(Class="text-xs text-slate-500 flex flex-col gap-1 mt-auto pt-4 border-t border-slate-50")
    meta <= html.SPAN(f"Last update: {p['last_updated']}")
    meta <= html.SPAN(f"Activity: {p['last_action']}", Class="text-slate-400 italic")
    body <= meta

    card <= body

    if app_state['open_menu_id'] == p['id']:
        dd = html.DIV(Class="absolute right-4 top-16 w-48 bg-white rounded-lg shadow-xl border border-slate-100 z-50 py-1 text-sm animate-in fade-in zoom-in-95 dropdown-menu")
        btn_open = html.A(Class="w-full text-left px-4 py-2 text-slate-700 hover:bg-slate-50 flex items-center gap-2", href=f"{URLS['holodeck']}/{p['id']}")
        btn_open <= html.I(**{'data-lucide': 'external-link', 'class': 'h-4 w-4'})
        btn_open <= "Open Holodeck"
        btn_del = html.BUTTON(Class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 flex items-center gap-2")
        btn_del <= html.I(**{'data-lucide': 'trash-2', 'class': 'h-4 w-4'})
        btn_del <= "Delete Project"
        dd <= btn_open
        dd <= btn_del
        card <= dd

    return card

init()
</script>

<style>
    .animate-fade-in { animation: fadeInUp 0.5s ease-out forwards; }
    .animate-in { animation: fadeInUp 0.5s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>