{{extend 'malayout.html'}}

<script id="treasury-data" type="application/json">
    {{=XML(data_json)}}
</script>

<div class="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">
{{include 'sidebar.html'}}

    <div class="flex-1 flex flex-col overflow-hidden relative">
        {{ page_title = "Fuel & Credits" }}
    {{include 'header.html'}}

        <main class="flex-1 overflow-y-auto p-8 bg-slate-50">
            
            <div class="bg-white rounded-xl p-8 shadow-sm border border-slate-200 mb-8 relative overflow-hidden">
                <div class="flex justify-between items-end mb-4 relative z-10">
                    <div>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Solde Actuel</p>
                        <h2 class="text-5xl font-black text-slate-900" id="balance-display">0</h2>
                        <p class="text-indigo-500 font-bold text-sm mt-1">Crédits Disponibles</p>
                    </div>
                    <div class="text-right">
                        <div class="bg-slate-50 px-4 py-2 rounded-lg border border-slate-100">
                            <p class="text-xs text-slate-500 font-bold uppercase">Autonomie Estimée</p>
                            <p class="text-sm font-medium text-slate-700 mt-1" id="prediction-text">Calculating...</p>
                        </div>
                    </div>
                </div>
                <div class="absolute -right-10 -bottom-10 opacity-5">
                    <i data-lucide="zap" class="h-64 w-64"></i>
                </div>
            </div>

            <h3 class="text-lg font-bold text-slate-800 mb-4">Recharger le Moteur</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all hover:-translate-y-1 group cursor-pointer" onclick="buyPack('starter')">
                    <div class="h-10 w-10 bg-slate-100 rounded-full flex items-center justify-center mb-4 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition">
                        <i data-lucide="battery" class="h-5 w-5"></i>
                    </div>
                    <h4 class="font-bold text-lg">Starter Pack</h4>
                    <p class="text-3xl font-bold mt-2">10$ <span class="text-sm text-slate-400 font-normal">HT</span></p>
                    <p class="text-indigo-600 font-bold text-sm mt-1">+ 1,000 Crédits</p>
                    <button class="w-full mt-6 py-2 rounded-lg border border-slate-200 font-bold text-sm text-slate-600 group-hover:border-indigo-600 group-hover:text-indigo-600 transition">Choisir</button>
                </div>

                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-xl transform scale-105 relative overflow-hidden cursor-pointer" onclick="buyPack('builder')">
                    <div class="absolute top-0 right-0 bg-indigo-500 text-white text-[10px] font-bold px-3 py-1 rounded-bl-lg uppercase">Populaire</div>
                    <div class="h-10 w-10 bg-slate-800 rounded-full flex items-center justify-center mb-4 text-indigo-400">
                        <i data-lucide="battery-charging" class="h-5 w-5"></i>
                    </div>
                    <h4 class="font-bold text-lg text-white">Builder Pack</h4>
                    <p class="text-3xl font-bold mt-2 text-white">39$ <span class="text-sm text-slate-500 font-normal">HT</span></p>
                    <p class="text-green-400 font-bold text-sm mt-1">+ 5,000 Crédits</p>
                    <p class="text-xs text-slate-500 mt-1">Bonus +25% inclus</p>
                    <button class="w-full mt-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 font-bold text-sm text-white transition shadow-lg shadow-indigo-900/50">Choisir</button>
                </div>

                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all hover:-translate-y-1 group cursor-pointer" onclick="buyPack('agency')">
                    <div class="h-10 w-10 bg-slate-100 rounded-full flex items-center justify-center mb-4 group-hover:bg-purple-50 group-hover:text-purple-600 transition">
                        <i data-lucide="battery-full" class="h-5 w-5"></i>
                    </div>
                    <h4 class="font-bold text-lg">Agency Pack</h4>
                    <p class="text-3xl font-bold mt-2">129$ <span class="text-sm text-slate-400 font-normal">HT</span></p>
                    <p class="text-purple-600 font-bold text-sm mt-1">+ 20,000 Crédits</p>
                    <p class="text-xs text-slate-400 mt-1">Bonus +50% inclus</p>
                    <button class="w-full mt-6 py-2 rounded-lg border border-slate-200 font-bold text-sm text-slate-600 group-hover:border-purple-600 group-hover:text-purple-600 transition">Choisir</button>
                </div>

            </div>

            <h3 class="text-lg font-bold text-slate-800 mb-4">Transactions Récentes</h3>
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <table class="w-full text-left">
                    <tbody id="history-body" class="text-sm text-slate-600">
                        </tbody>
                </table>
            </div>

        </main>
    </div>
</div>

<script type="text/python">
from browser import document, html, window, ajax
import json

def init():
    # 1. Parse Data
    try:
        data = json.loads(document['treasury-data'].text)
    except:
        data = {"balance": 0, "history": []}

    # 2. Update Hero
    document['balance-display'].text = f"{data.get('balance', 0):,}"
    document['prediction-text'].text = data.get('prediction', 'No data')

    # 3. Render History
    tbody = document['history-body']
    tbody.clear()
    
    for item in data.get('history', []):
        row = html.TR(Class="border-b border-slate-50 last:border-none hover:bg-slate-50 transition")
        
        # Icone selon type (Positif/Négatif)
        is_positive = item['amount'] > 0
        icon_name = "arrow-down-left" if is_positive else "arrow-up-right"
        color_cls = "text-green-600 bg-green-50" if is_positive else "text-slate-400 bg-slate-100"
        
        icon_cell = html.TD(Class="px-6 py-4 w-16")
        icon_div = html.DIV(Class=f"h-8 w-8 rounded-full flex items-center justify-center {color_cls}")
        icon_div <= html.I(**{'data-lucide': icon_name, 'class': 'h-4 w-4'})
        icon_cell <= icon_div
        row <= icon_cell
        
        # Description & Date
        desc_cell = html.TD(Class="px-6 py-4")
        desc_cell <= html.DIV(item['desc'], Class="font-bold text-slate-700")
        desc_cell <= html.DIV(item['date'], Class="text-xs text-slate-400")
        row <= desc_cell
        
        # Montant
        amt_str = f"+{item['amount']}" if is_positive else str(item['amount'])
        amt_cls = "font-mono font-bold text-green-600" if is_positive else "font-mono text-slate-600"
        row <= html.TD(amt_str, Class=f"px-6 py-4 text-right {amt_cls}")
        
        tbody <= row

    if hasattr(window, 'lucide'): window.lucide.createIcons()

def on_checkout_success(req):
    """Redirige vers Stripe quand l'URL est reçue"""
    try:
        data = json.loads(req.text)
        # Redirection vers la page de paiement sécurisée
        window.location.href = data['url']
    except:
        window.alert("Erreur lors de la création du paiement.")

def buy_pack_click(pack_id):
    """Déclenche l'achat"""
    # Change le curseur pour montrer que ça charge
    document.body.style.cursor = "wait"
    
    # Appel AJAX vers notre contrôleur Python
    req = ajax.ajax()
    req.bind('complete', on_checkout_success)
    req.open('POST', "{{=URL('default', 'buy_credits')}}", True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send({'pack': pack_id})

# On expose la fonction au Javascript global pour les onclick=""
window.buyPack = buy_pack_click

init()
</script>