{{extend 'malayout.html'}}

<style>
    @media print {
        /* Cache tout le site normal */
        body > * { display: none !important; }
        
        /* Affiche uniquement la facture */
        #invoice-template { 
            display: block !important; 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
        }
        
        /* Force la visibilité du contenu */
        #invoice-template * { visibility: visible !important; }
        
        /* Réinitialise les marges pour l'impression */
        @page { margin: 0; }
        body { margin: 1.6cm; }
    }
</style>

<script id="treasury-data" type="application/json">
    {{=XML(data_json)}}
</script>

<div class="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden print:hidden">
{{include 'sidebar.html'}}

    <div class="flex-1 flex flex-col overflow-hidden relative">
        {{ page_title = "Fuel & Credits" }}
        {{include 'header.html'}}

        <main class="flex-1 overflow-y-auto p-6 bg-slate-50">
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 mb-6 relative overflow-hidden">
                <div class="flex justify-between items-end mb-4 relative z-10">
                    <div>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Current Balance</p>
                        <h2 class="text-4xl font-black text-slate-900" id="balance-display">0</h2>
                        <p class="text-indigo-500 font-bold text-xs mt-1">Available Credits</p>
                    </div>
                    <div class="text-right">
                        <div class="bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                            <p class="text-[10px] text-slate-500 font-bold uppercase">Estimated Range</p>
                            <p class="text-xs font-medium text-slate-700 mt-1" id="prediction-text">Calculating...</p>
                        </div>
                    </div>
                </div>
                <div class="absolute -right-10 -bottom-10 opacity-5">
                    <i data-lucide="zap" class="h-48 w-48"></i>
                </div>
            </div>

            <h3 class="text-sm font-bold text-slate-800 mb-3 uppercase tracking-wide">Refuel Reactor</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-all hover:-translate-y-1 group">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-sm text-slate-700">Starter Pack</h4>
                            <p class="text-indigo-600 font-bold text-xs">+ 1,000 Credits</p>
                        </div>
                        <div class="h-8 w-8 bg-slate-50 rounded-full flex items-center justify-center group-hover:bg-indigo-50 group-hover:text-indigo-600 transition">
                            <i data-lucide="battery" class="h-4 w-4"></i>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <p class="text-xl font-bold">10$</p>
                        <button id="btn-starter" onclick="buyPack('starter')" class="px-4 py-1.5 rounded bg-slate-50 border border-slate-200 text-xs font-bold text-slate-600 hover:border-indigo-200 hover:text-indigo-600 transition flex items-center gap-2 justify-center min-w-[80px]">
                            Buy
                        </button>
                    </div>
                </div>

                <div class="bg-slate-900 p-4 rounded-lg border border-slate-800 shadow-lg transform scale-105 relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-indigo-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg uppercase">Best</div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-sm text-white">Builder Pack</h4>
                            <p class="text-green-400 font-bold text-xs">+ 5,000 Credits</p>
                        </div>
                        <div class="h-8 w-8 bg-slate-800 rounded-full flex items-center justify-center text-indigo-400">
                            <i data-lucide="battery-charging" class="h-4 w-4"></i>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <p class="text-xl font-bold text-white">39$</p>
                        <button id="btn-builder" onclick="buyPack('builder')" class="px-4 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-xs font-bold text-white transition shadow-lg shadow-indigo-900/50 flex items-center gap-2 justify-center min-w-[80px]">
                            Buy
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-all hover:-translate-y-1 group">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-sm text-slate-700">Agency Pack</h4>
                            <p class="text-purple-600 font-bold text-xs">+ 20,000 Credits</p>
                        </div>
                        <div class="h-8 w-8 bg-slate-50 rounded-full flex items-center justify-center group-hover:bg-purple-50 group-hover:text-purple-600 transition">
                            <i data-lucide="battery-full" class="h-4 w-4"></i>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <p class="text-xl font-bold">129$</p>
                        <button id="btn-agency" onclick="buyPack('agency')" class="px-4 py-1.5 rounded bg-slate-50 border border-slate-200 text-xs font-bold text-slate-600 hover:border-purple-200 hover:text-purple-600 transition flex items-center gap-2 justify-center min-w-[80px]">
                            Buy
                        </button>
                    </div>
                </div>
            </div>

            <h3 class="text-sm font-bold text-slate-800 mb-3 uppercase tracking-wide">History</h3>
            
            <div class="bg-white rounded-lg border border-slate-200 shadow-sm flex flex-col h-96">
                <div class="px-4 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-slate-500 uppercase">Recent Transactions</span>
                    <button class="text-[10px] text-indigo-500 font-bold hover:underline">View All</button>
                </div>

                <div class="overflow-y-auto flex-1 p-0 custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <tbody id="history-body" class="text-xs text-slate-600 divide-y divide-slate-50">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>
</div>

<div id="invoice-template" class="hidden">
    <div class="p-10 bg-white max-w-3xl mx-auto text-slate-900 font-sans print:max-w-full">
        
        <div class="flex justify-between items-start mb-12">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="ship" class="h-8 w-8 text-indigo-600"></i>
                    <span class="font-bold text-2xl tracking-tight text-slate-900">YourFirstShip</span>
                </div>
                <p class="text-sm text-slate-500">8 rue Charles Gide, 77130 Varennes sur Seine, France</p>
                <p class="text-sm text-slate-500">VAT ID: FR 478 310 097 00025</p> 
            </div>
            <div class="text-right">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">INVOICE</h1>
                <p class="text-sm text-slate-500">Ref: <span id="inv-ref" class="font-mono font-bold text-slate-700">#INV-000</span></p>
                <p class="text-sm text-slate-500">Date: <span id="inv-date">01/01/2024</span></p>
            </div>
        </div>

        <div class="mb-12 p-6 bg-slate-50 rounded-lg border border-slate-100 print:bg-slate-50 print:border-slate-200">
            <p class="text-xs font-bold text-slate-400 uppercase mb-2">Billed to:</p>
            <h3 class="font-bold text-lg" id="inv-client-name">Client Name</h3>
            <p class="text-slate-600 whitespace-pre-line" id="inv-client-address">Address...</p>
        </div>

        <table class="w-full mb-8">
            <thead>
                <tr class="border-b-2 border-slate-200">
                    <th class="text-left py-3 font-bold text-sm uppercase text-slate-500">Description</th>
                    <th class="text-right py-3 font-bold text-sm uppercase text-slate-500">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="py-4 border-b border-slate-100 font-medium text-lg">
                        <span id="inv-pack">Pack Name</span>
                    </td>
                    <td class="py-4 border-b border-slate-100 text-right font-bold text-lg">
                        <span id="inv-amount">0.00 $</span>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="flex justify-end">
            <div class="w-1/2 space-y-2">
                <div class="flex justify-between text-slate-500 text-sm">
                    <span>Tax (VAT)</span>
                    <span id="inv-tax">0.00 $</span>
                </div>
                <div class="flex justify-between py-2 border-t border-slate-200">
                    <span class="font-bold text-xl">Total Paid</span>
                    <span id="inv-total" class="font-bold text-xl text-indigo-600">0.00 $</span>
                </div>
            </div>
        </div>

        <div class="mt-16 pt-8 border-t border-slate-200 text-center text-xs text-slate-400">
            Thank you for your business. Generated automatically by YourFirstShip.
        </div>
    </div>
</div>

<div id="toast-notification" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-4 transform translate-y-32 transition-transform duration-300 z-50">
    <div class="flex items-center gap-2">
        <i data-lucide="check-circle" class="h-5 w-5 text-green-400"></i>
        <span class="font-bold">Payment successful!</span>
    </div>
</div>

<script type="text/python">
from browser import document, html, window, ajax, timer
import json

def init():
    try:
        data = json.loads(document['treasury-data'].text)
    except:
        data = {"balance": 0, "history": []}

    document['balance-display'].text = f"{data.get('balance', 0):,}"
    document['prediction-text'].text = data.get('prediction', 'No data')

    render_history(data.get('history', []))
    
    handle_toast()
    if hasattr(window, 'lucide'): window.lucide.createIcons()

def render_history(history):
    tbody = document['history-body']
    tbody.clear()
    
    for item in history:
        row = html.TR(Class="hover:bg-indigo-50/30 transition group border-b border-slate-50 last:border-0")
        
        # 1. Icone (Type)
        is_positive = item['amount'] > 0
        icon_name = "arrow-down-left" if is_positive else "arrow-up-right"
        color_cls = "text-green-600 bg-green-50" if is_positive else "text-slate-400 bg-slate-100"
        
        icon_cell = html.TD(Class="px-4 py-3 w-12") 
        icon_div = html.DIV(Class=f"h-8 w-8 rounded-md flex items-center justify-center {color_cls}")
        icon_div <= html.I(**{'data-lucide': icon_name, 'class': 'h-4 w-4'})
        icon_cell <= icon_div
        row <= icon_cell
        
        # 2. Description
        desc_cell = html.TD(Class="px-4 py-3")
        desc_cell <= html.DIV(item['desc'], Class="font-bold text-slate-700 text-xs truncate max-w-[140px]")
        desc_cell <= html.DIV(item['date'], Class="text-[10px] text-slate-400")
        row <= desc_cell
        
        # 3. Montant
        amt_str = f"+{item['amount']}" if is_positive else str(item['amount'])
        amt_cls = "text-green-600" if is_positive else "text-slate-600"
        row <= html.TD(amt_str, Class=f"px-4 py-3 text-right font-mono font-bold text-xs {amt_cls}")

        # 4. BOUTON IMPRIMER
        print_cell = html.TD(Class="px-4 py-3 text-right w-12")
        
        if is_positive: 
            btn_print = html.BUTTON(Class="text-indigo-400 hover:text-indigo-600 p-2 rounded hover:bg-indigo-50 transition", Title="Download Invoice")
            btn_print <= html.I(**{'data-lucide': 'printer', 'class': 'h-4 w-4'})
            btn_print.bind('click', lambda ev, i=item: print_invoice(i))
            print_cell <= btn_print
        
        row <= print_cell
        tbody <= row

    if hasattr(window, 'lucide'): 
        window.lucide.createIcons()

def print_invoice(item):
    document['inv-date'].text = item.get('full_date', item['date'])
    document['inv-ref'].text = item.get('ref', 'REF-???')
    document['inv-client-name'].text = item.get('billing_name', 'Client')
    document['inv-client-address'].text = item.get('billing_address', '')
    document['inv-pack'].text = item.get('pack', item['desc'])
    document['inv-amount'].text = item.get('display_amount', str(item['amount']))
    document['inv-tax'].text = item.get('tax', '0.00')
    document['inv-total'].text = item.get('total', str(item['amount']))
    window.print()

def handle_toast():
    qs = window.location.search
    if "payment=success" in qs:
        # Vert pour le succès
        show_toast("Payment successful!", "text-green-500")
        clean_url()
    elif "payment=cancel" in qs:
        # Orange/Amber pour l'annulation (Bien mieux que l'alerte !)
        show_toast("Payment cancelled.", "text-amber-500")
        clean_url()

def clean_url():
    new_url = window.location.pathname
    window.history.replaceState({}, '', new_url)

def show_toast(msg, color):
    """
    Affiche le toast avec la bonne couleur.
    Note: On ne change pas l'icône (forme) car Lucide l'a déjà transformée en SVG,
    mais on change sa couleur, ce qui suffit pour indiquer l'état.
    """
    toast = document['toast-notification']
    toast.select_one('span').text = msg
    
    # Astuce : Lucide remplace <i> par <svg>, donc on cherche le SVG
    # S'il n'est pas encore là (rare), on cherche le i
    icon = toast.select_one('svg') or toast.select_one('i')
    
    if icon:
        # On force la couleur demandée + taille fixe
        # "class" est un mot réservé en Python, on utilise attrs['class'] ou className
        icon.attrs['class'] = f"h-5 w-5 {color}"
        
    toast.style.transform = "translateY(0)"
    timer.set_timeout(lambda: setattr(toast.style, 'transform', "translateY(8rem)"), 5000)

def on_checkout_success(req):
    try:
        data = json.loads(req.text)
        window.location.href = data['url']
    except:
        # Rouge pour l'erreur technique
        show_toast("Checkout Error", "text-red-500")

def buy_pack_click(pack_id):
    # 1. On récupère le bouton spécifique grâce à son ID
    btn_id = f"btn-{pack_id}"
    if btn_id in document:
        btn = document[btn_id]
        
        # 2. On fige la largeur pour éviter que le bouton ne change de taille
        # (optionnel mais plus joli)
        current_width = btn.offsetWidth
        btn.style.width = f"{current_width}px"
        
        # 3. On injecte le spinner SVG
        # On utilise 'text-current' pour que le spinner prenne la couleur du texte (blanc ou gris)
        btn.html = """
        <svg class="animate-spin h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        """
        
        # 4. On désactive le bouton pour éviter le double-clic
        btn.disabled = True
        btn.classList.add("cursor-not-allowed", "opacity-75")

    # 5. On lance la requête AJAX habituelle
    req = ajax.ajax()
    req.bind('complete', lambda r: on_checkout_complete(r, pack_id)) # J'ai changé le handler pour gérer le retour
    req.open('POST', "{{=URL('default', 'buy_credits')}}", True)
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send({'pack': pack_id})

# Nouvelle fonction intermédiaire pour gérer le cas d'erreur et réactiver le bouton
def on_checkout_complete(req, pack_id):
    try:
        data = json.loads(req.text)
        if 'url' in data:
            window.location.href = data['url']
        else:
            # Cas d'erreur géré par le backend
            reset_button(pack_id)
            show_toast(data.get('error', 'Error'), "text-red-500")
    except:
        reset_button(pack_id)
        show_toast("Checkout Error", "text-red-500")

def reset_button(pack_id):
    # En cas d'erreur, on remet le bouton comme avant
    btn_id = f"btn-{pack_id}"
    if btn_id in document:
        btn = document[btn_id]
        btn.text = "Acheter"
        btn.disabled = False
        btn.classList.remove("cursor-not-allowed", "opacity-75")
        btn.style.width = "" # Reset width

window.buyPack = buy_pack_click
init()
</script>