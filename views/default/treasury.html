{{extend 'malayout.html'}}

<script id="treasury-data" type="application/json">
    {{=XML(data_json)}}
</script>

<div class="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">

    <aside class="w-64 bg-slate-900 text-slate-300 hidden md:flex flex-col border-r border-slate-800">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <i data-lucide="ship" class="text-indigo-500 h-6 w-6 mr-3"></i>
            <span class="font-bold text-white text-lg tracking-tight">YourFirstShip</span>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <a href="{{=URL('dashboard')}}" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-800 hover:text-white rounded-lg transition-colors">
                <i data-lucide="layout-grid" class="h-5 w-5"></i><span class="font-medium">Dashboard</span>
            </a>
            <a href="{{=URL('treasury')}}" class="flex items-center gap-3 px-4 py-3 bg-indigo-600/10 text-indigo-400 rounded-lg border border-indigo-600/20">
                <i data-lucide="wallet" class="h-5 w-5"></i><span class="font-medium">Trésorerie</span>
            </a>
            <a href="{{=URL('support')}}" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-800 hover:text-white rounded-lg transition-colors">
                <i data-lucide="life-buoy" class="h-5 w-5"></i><span class="font-medium">Support</span>
            </a>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-xs">{{=user.first_name[0]}}</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-medium text-white truncate">{{=user.first_name}}</p>
                    <a href="{{=URL('user','profile')}}" class="text-xs text-slate-500 hover:text-indigo-400">Voir Profil</a>
                </div>
            </div>
            <a href="{{=URL('user', args='logout')}}" class="flex items-center gap-2 text-xs text-slate-500 hover:text-red-400 px-2 transition-colors">
                <i data-lucide="log-out" class="h-3 w-3"></i> Déconnexion
            </a>
        </div>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden relative">
        
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 z-20 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-bold text-slate-800">Ship's Treasury</h1>
            </div>
            <div class="flex items-center gap-2 text-xs text-slate-400">
                <i data-lucide="refresh-cw" class="h-3 w-3"></i>
                <span>Synced with Stripe</span>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-8 bg-slate-50 relative scroll-smooth">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8" id="stats-container">
                
                <div class="bg-slate-900 rounded-xl p-6 shadow-xl text-white relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                        <i data-lucide="credit-card" class="h-24 w-24"></i>
                    </div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Current License</p>
                            <h2 class="text-2xl font-bold mt-1" id="plan-name">Loading...</h2>
                        </div>
                        <span class="px-2 py-1 bg-green-500/20 text-green-400 text-[10px] font-bold uppercase rounded border border-green-500/30">Active</span>
                    </div>

                    <div class="mt-6 flex items-end justify-between">
                        <div>
                            <p class="text-3xl font-bold" id="plan-price">--</p>
                            <p class="text-xs text-slate-400 mt-1">Renews on <span id="renewal-date" class="text-white">...</span></p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2 text-sm text-slate-300 mb-1">
                                <i data-lucide="credit-card" class="h-4 w-4"></i>
                                <span class="font-mono">•••• <span id="card-last4">0000</span></span>
                            </div>
                            <button class="text-xs text-indigo-400 hover:text-white underline transition">Manage Plan</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 flex flex-col justify-between">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="zap" class="h-3 w-3 text-amber-500"></i> AI Fuel Level
                        </p>
                        <span id="credits-fraction" class="text-sm font-mono font-bold text-slate-700">-- / --</span>
                    </div>

                    <div class="flex-1 flex flex-col justify-center py-2">
                        <div class="h-4 w-full bg-slate-100 rounded-full overflow-hidden relative shadow-inner">
                            <div class="absolute inset-0 z-10 flex w-full h-full">
                                <div class="flex-1 border-r border-white/50 h-full"></div>
                                <div class="flex-1 border-r border-white/50 h-full"></div>
                                <div class="flex-1 border-r border-white/50 h-full"></div>
                                <div class="flex-1 h-full"></div>
                            </div>
                            <div id="fuel-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 transition-all duration-1000 ease-out relative z-0"></div>
                        </div>
                    </div>

                    <div class="mt-2 bg-slate-50 p-3 rounded-lg border border-slate-100 flex gap-3 items-start">
                        <div class="mt-0.5"><i data-lucide="bot" class="h-4 w-4 text-indigo-500"></i></div>
                        <div>
                            <p class="text-[10px] font-bold text-indigo-900 uppercase">AI Projection</p>
                            <p class="text-xs text-slate-600 leading-snug italic" id="ai-prediction">Calculating consumption...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 flex flex-col">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="fuel" class="h-3 w-3 text-red-500"></i> Refill Station
                    </p>
                    
                    <div class="flex-1 flex flex-col justify-center gap-3">
                        <div class="flex items-center justify-between p-3 border border-indigo-100 rounded-lg hover:border-indigo-300 transition cursor-pointer group bg-indigo-50/50">
                            <div class="flex items-center gap-3">
                                <div class="h-8 w-8 bg-white rounded-full flex items-center justify-center text-indigo-600 shadow-sm border border-indigo-100">
                                    <i data-lucide="battery-charging" class="h-4 w-4"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-sm text-slate-800">Booster Pack</div>
                                    <div class="text-[10px] text-slate-500">+250 Actions</div>
                                </div>
                            </div>
                            <button id="btn-topup" class="bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-600 hover:text-white px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm">
                                10€
                            </button>
                        </div>
                        
                        <p class="text-[10px] text-center text-slate-400 mt-2">
                            One-time charge. Added instantly.
                        </p>
                    </div>
                </div>

            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Logbook & Receipts</h3>
                    <button class="text-xs text-slate-500 hover:text-indigo-600 flex items-center gap-1">
                        View All on Stripe <i data-lucide="external-link" class="h-3 w-3"></i>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-xs text-slate-400 border-b border-slate-100">
                                <th class="px-6 py-3 font-medium uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 font-medium uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 font-medium uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 font-medium uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 font-medium uppercase tracking-wider text-right">Invoice</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm text-slate-600" id="invoices-body">
                            </tbody>
                    </table>
                </div>
                <div id="empty-invoices" class="hidden p-8 text-center">
                    <p class="text-slate-400 text-sm">No transactions yet.</p>
                </div>
            </div>

        </main>
    </div>
</div>

<script type="text/python">
from browser import document, html, window, timer
import json

def init():
    # 1. Load Data
    raw_data = document['treasury-data'].text
    if not raw_data or raw_data == "None":
        data = {}
    else:
        data = json.loads(raw_data)
    
    sub = data.get('sub', {})
    usage = data.get('usage', {})
    invoices = data.get('invoices', [])

    # 2. Render Subscription Card
    document['plan-name'].text = sub.get('plan_name', 'Free')
    document['plan-price'].text = f"{sub.get('price', 0)}{sub.get('currency', '€')}/{sub.get('interval', 'mo')}"
    document['renewal-date'].text = sub.get('renewal_date', '-')
    document['card-last4'].text = sub.get('card_last4', '----')

    # 3. Render Fuel Gauge
    total = usage.get('credits_total', 1)
    used = usage.get('credits_used', 0)
    
    # Handle "Unlimited" case
    if total == '∞':
        percent = 100
        color_cls = "bg-green-500"
        document['credits-fraction'].text = "Unlimited"
    else:
        percent = int((1 - (used / total)) * 100) # Remaining %
        document['credits-fraction'].text = f"{usage.get('credits_remaining')} / {total}"
        
        # Color Logic
        if percent > 50:
            color_cls = "bg-gradient-to-r from-green-500 to-emerald-400"
        elif percent > 20:
            color_cls = "bg-gradient-to-r from-yellow-400 to-orange-500"
        else:
            color_cls = "bg-gradient-to-r from-red-500 to-red-600"

    # Apply Animation
    bar = document['fuel-bar']
    bar.style.width = f"{percent}%"
    bar.className = f"h-full {color_cls} transition-all duration-1000 ease-out relative z-0"

    # AI Prediction
    document['ai-prediction'].text = f"\"{usage.get('ai_prediction', '')}\""

    # 4. Render Invoices
    tbody = document['invoices-body']
    tbody.clear()
    
    if not invoices:
        document['empty-invoices'].classList.remove('hidden')
    else:
        for inv in invoices:
            row = html.TR(Class="hover:bg-slate-50 transition border-b border-slate-50 last:border-none")
            
            row <= html.TD(inv['date'], Class="px-6 py-4 whitespace-nowrap")
            
            desc = inv.get('desc', f"Monthly {sub.get('plan_name')} Plan")
            row <= html.TD(desc, Class="px-6 py-4 font-medium text-slate-800")
            
            row <= html.TD(inv['amount'], Class="px-6 py-4 font-mono")
            
            # Status Badge
            status_cell = html.TD(Class="px-6 py-4")
            if inv['status'] == 'Paid':
                badge = html.SPAN("Paid", Class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold uppercase")
            else:
                badge = html.SPAN(inv['status'], Class="px-2 py-1 rounded bg-slate-100 text-slate-500 text-xs font-bold uppercase")
            status_cell <= badge
            row <= status_cell
            
            # Action
            action_cell = html.TD(Class="px-6 py-4 text-right")
            btn = html.A(Class="text-slate-400 hover:text-indigo-600 transition", href=inv['pdf_url'])
            btn <= html.I(**{'data-lucide': 'download', 'class': 'h-4 w-4'})
            action_cell <= btn
            row <= action_cell
            
            tbody <= row

    # 5. Bindings
    document['btn-topup'].bind('click', handle_topup)
    
    if hasattr(window, 'lucide'): window.lucide.createIcons()

def handle_topup(ev):
    # Mock Stripe Checkout
    alert("Redirection vers Stripe Checkout (10€)...")

init()
</script>